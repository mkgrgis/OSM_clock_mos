-- –ù–∏–∂–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —Å—Ç–æ–ª–±–∞–º
REFRESH MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru";
SELECT count(*) FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru";

CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 10" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 10.0) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" x;
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 10 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 10" (b);  
  
CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 15" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 15.0) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" x;
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 15 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 15" (b);
  
CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 20" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 20.0) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" x;
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 20 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 20" (b);  
  
CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 8" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 8) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" x;  
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 8 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 8" (b);

CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 5" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 5) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" x;
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 5 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î 5" (b);  

CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 15" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 15.0) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã OSM" x;  
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 15 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 15" (b);

CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 20" as
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 20.0) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã OSM" x;  
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 20 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 20" (b);

CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 8" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 8) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã OSM" x;
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 8 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 8" (b);  
  
CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 5" AS
SELECT x.œÜŒª,
       x."–ö–æ–¥",
       x."‚Ññ",
       ST_Buffer(st_transform(x.œÜŒª,4326)::geography, 5) b
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã OSM" x;  
CREATE INDEX "2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 5 b IDX" ON "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ OSM 5" (b);
  

DROP MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."3 –°—Ç–æ–ª–±—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π";
CREATE MATERIALIZED VIEW "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."3 –°—Ç–æ–ª–±—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π" as
SELECT —Åo."–ö–æ–¥ OSM",
       —Åo.œÜŒª œÜŒª_OSM,       
       —Åo."–û–ø–µ—Ä–∞—Ç–æ—Ä",
       —Åo."nüí°" "nüí° OSM",
       —Åo."–í–≤–æ–¥ –≤ —Å—Ç—Ä–æ–π",
       —Å–º.*,
       ST_Distance(st_transform(—Åo.œÜŒª,4326)::geography, st_transform(—Å–º.œÜŒª,4326)::geography) "Œî –º"
  FROM "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."2 –û–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–ª–±–æ–≤ –û–î" —Å–º   
  LEFT JOIN "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã OSM" —Åo 
    ON ST_Contains(—Å–º.b, —Åo.œÜŒª);
   
   
select —Å–ø.*
  from "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."3 –°—Ç–æ–ª–±—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π" —Å–ø
-- inner join "–ß–∞—Å—ã –ú–æ—Å–∫–≤—ã"."1 –°—Ç–æ–ª–±—ã data.mos.ru" —Ådmr
--    on —Ådmr."–ö–æ–¥" = —Å–ø."–ö–æ–¥"
 where —Å–ø."–û–∫—Ä—É–≥" = '–Æ–∂–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥'
   and —Å–ø.œÜŒª_osm is not null;
